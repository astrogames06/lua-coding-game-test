<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>web lua</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/midnight.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/lua/lua.min.js"></script>

    <style>
        body { margin: 0; }
        .container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }
        .CodeMirror {
            width: 50%;
            height: 450px;
        }
        #canvas {
            width: 50%;
        }
    </style>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/gh/eligrey/FileSaver.js/dist/FileSaver.min.js"> </script>
    <script type='text/javascript'>
        function saveFileFromMEMFSToDisk(memoryFSname, localFSname)     // This can be called by C/C++ code
        {
            var isSafari = false; // Not supported, navigator.userAgent access is being restricted
            //var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            var data = FS.readFile(memoryFSname);
            var blob;

            if (isSafari) blob = new Blob([data.buffer], { type: "application/octet-stream" });
            else blob = new Blob([data.buffer], { type: "application/octet-binary" });

            // NOTE: SaveAsDialog is a browser setting. For example, in Google Chrome,
            // in Settings/Advanced/Downloads section you have a setting:
            // 'Ask where to save each file before downloading' - which you can set true/false.
            // If you enable this setting it would always ask you and bring the SaveAsDialog
            saveAs(blob, localFSname);
        }
    </script>
    </head>
    <body>
        <div class="container">
            <textarea id="editor">function run_game()
end</textarea>
            <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
        </div>
        <button id="run-btn">run</button>
        <script>
            window.CodeMirror = CodeMirror.fromTextArea(document.getElementById("editor"), {
                mode: "lua",
                lineNumbers: true,
                theme: "midnight",
                tabSize: 4
            });

            window.Module = {
                onRuntimeInitialized: function () {
                    let run_btn = document.getElementById('run-btn');

                    run_btn.addEventListener('click', () => {
                        Module.RunLua(CodeMirror.getValue().toString());
                        Module.SetGame();

                        if (Module.LuaIsRunning())
                        {
                            run_btn.textContent = "Running";
                        }
                        else
                        {
                            run_btn.textContent = "Stop!";
                        }
                    })
                },
                canvas: (function() {
                    var canvas = document.getElementById('canvas');
                    return canvas;
                })(),
            };
        </script>
        {{{ SCRIPT }}}
    </body>
</html>
